<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FareWare</title>
  <style>
    :root{
      --ink:#111; --muted:#666; --stroke:#e6e6e6;
      --pill:#f4f5f7; --accent:#ff7f31; --accent-ink:#a84609; --accent-weak:#ffe9de;
      --round:14px;
    }
    *{box-sizing:border-box}
    body{font-family:-apple-system,system-ui,Segoe UI,Roboto,sans-serif;margin:16px;color:var(--ink);background:#fff}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .logo{height:28px;display:block}

    .iconbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;background:var(--pill);
      border:1px solid transparent;cursor:pointer;user-select:none}
    .chip.active{background:var(--accent-weak);border-color:#ffc299;color:var(--accent-ink)}
    .chip.icon-only{padding:10px}
    .ico{width:20px;height:20px;display:block;object-fit:contain}
    .chip .label{font-size:14px;line-height:1}

    .ctaTaste{display:flex;gap:8px;align-items:center;justify-content:center;background:var(--accent);color:#fff;border:none;
      width:100%;padding:12px;border-radius:12px;font-weight:600;cursor:pointer}
    .recentRow{display:flex;gap:8px;overflow:auto;padding:4px 0 6px}
    .bubble{border:1px solid var(--stroke);padding:10px 12px;border-radius:999px;white-space:nowrap;background:#fff;cursor:pointer}

    .searchRow{display:flex;gap:8px;margin-top:8px}
    .searchInput{flex:1;border:1px solid var(--stroke);border-radius:12px;padding:12px 14px;font-size:16px}
    .sendbtn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:1px solid var(--stroke);background:#fff;
      border-radius:12px;padding:10px 12px;cursor:pointer}

    #status{font-size:12px;color:var(--muted);margin:10px 0}
    #results{display:grid;gap:12px}
    .card{background:#fff;border:1px solid var(--stroke);border-radius:var(--round);overflow:hidden}
    .img{width:100%;height:180px;background:#eee;object-fit:cover;display:block}
    .pad{padding:12px}
    .title{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .name{font-weight:600;font-size:16px}
    .price{font-weight:600}
    .meta{color:var(--muted);font-size:13px;margin-top:4px}
    .rowBetween{display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:12px}
    .heart{border:1px solid var(--stroke);background:#fff;padding:8px;border-radius:10px;display:inline-flex;align-items:center}
    .heart.saved{background:var(--accent-weak);border-color:#ffc299}
    .tags a{color:#0b66d6;text-decoration:none;margin-right:6px}
    .detail{margin-top:16px}

    .spacer8{height:8px} .spacer12{height:12px}
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <img src="icons/logo.png" alt="FareWare" class="logo" />
    <button id="savedBtn" class="chip icon-only" title="Saved">
      <img class="ico" src="icons/bookmark.png" alt="saved" />
      <span id="savedCount">0</span>
    </button>
  </header>

  <!-- Icon chips row -->
  <div class="iconbar">
    <button id="chipOpen" class="chip" title="Open now">
      <img class="ico" src="icons/clock.png" alt="open" /><span class="label">Open</span>
    </button>

    <button id="chipPrice" class="chip active" title="Toggle price">
      <img class="ico" src="icons/dollar.png" alt="price" /><span class="label">≤ $$</span>
    </button>

    <button id="chipRadius" class="chip" title="Search radius">
      <img class="ico" src="icons/car.png" alt="distance" /><span class="label">≤ 5 mi</span>
    </button>

    <button id="chipFilters" class="chip icon-only" title="More filters">
      <img class="ico" src="icons/sliders.png" alt="filters" />
    </button>
  </div>

  <div class="spacer8"></div>

  <!-- Big CTA -->
  <button id="tasteBtn" class="ctaTaste">Personalize with Your Taste</button>

  <div class="spacer12"></div>

  <!-- Recent searches -->
  <div id="recentRow" class="recentRow"></div>

  <!-- Search row -->
  <div class="searchRow">
    <input id="q" class="searchInput" type="search" placeholder="What are you craving?" />
    <button id="go" class="sendbtn" title="Search">
      <img class="ico" src="icons/send.png" alt="search" />
    </button>
  </div>

  <div id="status"></div>
  <div id="results"></div>
  <div id="detail" class="detail"></div>

  <script>
    const FN_PLACES  = '/.netlify/functions/places';
    const FN_DETAILS = '/.netlify/functions/placeDetails';
    const FN_PHOTO   = '/.netlify/functions/photo';

    let CURRENT_COORDS = { lat:41.7508, lng:-88.1535 };
    let filters = { openNow:false, maxPrice:2, radiusMi:5 };
    let saved = new Set(JSON.parse(localStorage.getItem('fw_saved')||'[]'));
    let recent = JSON.parse(localStorage.getItem('fw_recent')||'[]');

    const q = document.getElementById('q');
    const go = document.getElementById('go');
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const detailEl  = document.getElementById('detail');
    const chipOpen  = document.getElementById('chipOpen');
    const chipPrice = document.getElementById('chipPrice');
    const chipRadius= document.getElementById('chipRadius');
    const chipFilters= document.getElementById('chipFilters');
    const tasteBtn  = document.getElementById('tasteBtn');
    const savedBtn  = document.getElementById('savedBtn');
    const savedCount= document.getElementById('savedCount');
    const recentRow = document.getElementById('recentRow');

    const dollars = n => n ? '$'.repeat(n) : '';
    function miles(from,to){
      if(!from||!to) return '';
      const R=3958.7613, dLat=(to.lat-from.lat)*Math.PI/180, dLng=(to.lng-from.lng)*Math.PI/180;
      const a=Math.sin(dLat/2)**2 + Math.cos(from.lat*Math.PI/180)*Math.cos(to.lat*Math.PI/180)*Math.sin(dLng/2)**2;
      return (R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))).toFixed(1)+' mi';
    }
    function tagLink(t){ return `<a href="#" data-term="${t}">#${t.replace(/_/g,'')}</a>`; }

    function setCoords(lat,lng){ CURRENT_COORDS={lat,lng}; }
    function handleFWMessage(raw){
      try{
        const msg = JSON.parse(raw||'{}');
        if(msg.type==='FW_COORDS' && msg.payload?.lat && msg.payload?.lng){
          setCoords(msg.payload.lat,msg.payload.lng);
          if(!q.value) q.value='sushi';
          onSearch();
        }
      }catch{}
    }
    window.addEventListener('message',e=>handleFWMessage(e.data),false);
    document.addEventListener('message',e=>handleFWMessage(e.data),false);
    try{ window.ReactNativeWebView?.postMessage(JSON.stringify({type:'FW_READY'})); }catch{}

    function renderRecent(){
      recentRow.innerHTML = recent.slice(0,6).map(t=>`<button class="bubble" data-term="${t}">${t}</button>`).join('');
      [...recentRow.querySelectorAll('.bubble')].forEach(b=>{
        b.addEventListener('click',()=>{ q.value=b.dataset.term; onSearch(); });
      });
    }
    function addRecent(term){
      term=(term||'').trim(); if(!term) return;
      recent=[term, ...recent.filter(t=>t.toLowerCase()!==term.toLowerCase())].slice(0,10);
      localStorage.setItem('fw_recent', JSON.stringify(recent));
      renderRecent();
    }
    renderRecent();

    function updateSavedCount(){ savedCount.textContent=String(saved.size); }
    updateSavedCount();
    savedBtn.addEventListener('click', ()=>{
      if(!saved.size){ statusEl.textContent='No saved places yet.'; return; }
      statusEl.textContent='Saved places';
      detailEl.innerHTML=''; resultsEl.innerHTML='';
      const ul=document.createElement('ul');
      saved.forEach(id=>{ const li=document.createElement('li'); li.textContent=id; ul.appendChild(li); });
      resultsEl.appendChild(ul);
    });

    chipOpen.addEventListener('click', ()=>{
      filters.openNow=!filters.openNow;
      chipOpen.classList.toggle('active', filters.openNow);
      onSearch();
    });
    chipPrice.addEventListener('click', ()=>{
      filters.maxPrice = filters.maxPrice===2 ? 3 : 2;
      chipPrice.classList.toggle('active', filters.maxPrice<=2);
      chipPrice.querySelector('.label').textContent = filters.maxPrice<=2 ? '≤ $$' : 'Up to $$$';
      onSearch();
    });
    chipRadius.addEventListener('click', ()=>{
      const order=[3,5,8];
      const idx=order.indexOf(filters.radiusMi);
      filters.radiusMi = order[(idx+1)%order.length];
      chipRadius.querySelector('.label').textContent = `≤ ${filters.radiusMi} mi`;
      onSearch();
    });
    chipFilters.addEventListener('click', ()=>{ alert('More filters coming soon ✨'); });
    tasteBtn.addEventListener('click', ()=>{ alert('Launching “Your Taste” questionnaire soon!'); });

    go.addEventListener('click', onSearch);
    q.addEventListener('keydown', e=>{ if(e.key==='Enter') onSearch(); });

    async function onSearch(){
      const term=(q.value||'sushi').trim();
      addRecent(term);

      resultsEl.innerHTML=''; detailEl.innerHTML=''; statusEl.textContent='Searching…';

      const meters = Math.round(filters.radiusMi * 1609.34);
      const query = term.toLowerCase().includes('restaurant') ? term : `${term} restaurant`;

      try{
        const res = await fetch(FN_PLACES,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            query,
            lat: CURRENT_COORDS.lat, lng: CURRENT_COORDS.lng,
            radius: meters,
            openNow: filters.openNow ? 1 : 0,
            maxprice: filters.maxPrice
          })
        });
        const data = await res.json();
        if(data.error){ statusEl.textContent=`Places error: ${data.error}${data.error_message?' – '+data.error_message:''}`; return; }
        render(data.places||[]);
      }catch(e){ statusEl.textContent='Error: '+e.message; }
    }

    function render(places){
      statusEl.textContent = places.length ? `Found ${places.length} places` : 'No results';
      resultsEl.innerHTML = places.map(p=>{
        const distance = miles(CURRENT_COORDS, p.location);
        const img = p.photo_ref ? `${FN_PHOTO}?ref=${encodeURIComponent(p.photo_ref)}&maxwidth=900` : '';
        const tags = (p.types||[]).slice(0,4).map(tagLink).join(' ');
        const isSaved = saved.has(p.place_id);
        return `
          <div class="card" data-id="${p.place_id}">
            ${img ? `<img class="img" src="${img}" alt="">` : `<div class="img"></div>`}
            <div class="pad">
              <div class="title">
                <div class="name">${p.name??'Unknown'}</div>
                <div class="price">${dollars(p.price_level)}</div>
              </div>
              <div class="meta">★ ${p.rating??'—'} · ${p.user_ratings_total??0} · ${distance}</div>
              <div class="rowBetween">
                <div class="meta tags">${tags}</div>
                <button class="heart ${isSaved?'saved':''}" type="button" aria-label="Save">
                  <img class="ico" src="icons/heart.png" alt="save" />
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      [...resultsEl.querySelectorAll('.card')].forEach(el=>{
        el.addEventListener('click',(e)=>{
          if(e.target.closest('.tags')||e.target.closest('.heart')) return;
          showDetails(el.dataset.id);
        });
      });

      [...resultsEl.querySelectorAll('.heart')].forEach(btn=>{
        btn.addEventListener('click',(e)=>{
          e.stopPropagation();
          const id = btn.closest('.card')?.dataset.id;
          if(!id) return;
          if(saved.has(id)){ saved.delete(id); btn.classList.remove('saved'); }
          else { saved.add(id); btn.classList.add('saved'); }
          localStorage.setItem('fw_saved', JSON.stringify([...saved]));
          updateSavedCount();
        });
      });

      [...resultsEl.querySelectorAll('.tags a')].forEach(a=>{
        a.addEventListener('click',(e)=>{
          e.preventDefault(); e.stopPropagation();
          const term=a.getAttribute('data-term');
          q.value=term; onSearch();
        });
      });
    }

    async function showDetails(place_id){
      detailEl.innerHTML='Loading details…';
      try{
        const res = await fetch(FN_DETAILS,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ place_id })
        });
        const d = await res.json();
        if(d.error){ detailEl.textContent=`Details error: ${d.error} ${d.error_message||''}`; return; }
        const img = d.photo_ref ? `${FN_PHOTO}?ref=${encodeURIComponent(d.photo_ref)}&maxwidth=1200` : '';
        const hours = d.opening_hours?.weekday_text ? d.opening_hours.weekday_text.join('<br/>') : '';
        detailEl.innerHTML = `
          <div class="card" style="border-color:#ccc">
            ${img?`<img class="img" src="${img}" alt="" style="height:220px">`:''}
            <div class="pad">
              <div class="title">
                <div class="name" style="font-size:18px">${d.name}</div>
                <div class="price">${dollars(d.price_level)}</div>
              </div>
              <div class="meta">★ ${d.rating??'—'} · ${d.user_ratings_total??0}</div>
              <div class="meta">${d.address??''}</div>
              <div class="meta">${d.phone?('☎︎ '+d.phone):''} ${d.website?` • <a href="${d.website}" target="_blank" rel="noopener">Website</a>`:''}</div>
              ${hours?`<div class="meta" style="margin-top:6px">${hours}</div>`:''}
            </div>
          </div>`;
      }catch(e){ detailEl.textContent='Failed to load details: '+e.message; }
    }

    q.value='Best sushi';
  </script>
</body>
</html>
