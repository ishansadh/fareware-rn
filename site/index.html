<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FareWare</title>
  <style>
    :root { --pill:#f4f5f7; --accent:#ff7f31; --ink:#111; --muted:#666; --stroke:#e6e6e6; }
    * { box-sizing: border-box; }
    body { font-family:-apple-system,system-ui,Segoe UI,Roboto,sans-serif; margin:16px; color:var(--ink); background:#fff; }
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
    .logo { height:28px; display:block; }
    .iconbtn { border:none; background:#fff; padding:8px; border-radius:10px; border:1px solid var(--stroke); }

    .search { display:flex; gap:8px; }
    input[type=search] { flex:1; padding:12px 14px; border:1px solid #ddd; border-radius:12px; font-size:16px; }
    button { padding:10px 12px; border-radius:12px; border:1px solid #ddd; background:#fff; font-size:14px; cursor:pointer; display:inline-flex; align-items:center; gap:8px; }
    .send { border-color: var(--stroke); }
    .row { display:flex; gap:8px; flex-wrap:wrap; margin:10px 0; }
    .pill { background:var(--pill); padding:8px 12px; border-radius:999px; font-size:14px; cursor:pointer; display:inline-flex; align-items:center; gap:6px; }
    .pill.active { background:#ffe9de; color:#a84609; border:1px solid #ffc299; }
    #status { font-size:12px; color:var(--muted); margin:6px 0 12px; }

    #results { display:grid; gap:12px; }
    .card { display:block; background:#fff; border:1px solid var(--stroke); border-radius:14px; overflow:hidden; text-align:left; }
    .img { width:100%; height:180px; background:#eee; object-fit:cover; display:block; }
    .pad { padding:12px; }
    .title { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .name { font-weight:600; font-size:16px; }
    .price { color:#111; font-weight:600; }
    .meta { color:var(--muted); font-size:13px; margin-top:4px; }
    .rowBetween { display:flex; justify-content:space-between; align-items:center; margin-top:8px; gap:12px; }
    .heart { border:none; background:#fff; padding:8px; border-radius:10px; border:1px solid var(--stroke); display:inline-flex; align-items:center; gap:6px; }
    .heart.saved { background:#ffe9de; border-color:#ffc299; }
    .tags a { color:#0b66d6; text-decoration:none; margin-right:6px; }
    .detail { margin-top:16px; }
    a { color:#0b66d6; text-decoration:none; }
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <header>
    <img src="logo.svg" alt="FareWare" class="logo" onerror="this.src=''; this.alt='FareWare';" />
    <button class="iconbtn" id="savedBtn" title="Saved">
      <!-- bookmark icon -->
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 3h12a1 1 0 0 1 1 1v17l-7-4-7 4V4a1 1 0 0 1 1-1z" stroke="#222" stroke-width="1.5" fill="none"/></svg>
      <span id="savedCount">0</span>
    </button>
  </header>

  <div class="search">
    <input id="q" type="search" placeholder="Search restaurants or dishes…" />
    <button id="go" type="button" class="send" title="Search">
      <!-- paper plane icon -->
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M22 2 11 13" stroke="#222" stroke-width="1.5"/><path d="m22 2-7 20-4-9-9-4 20-7Z" stroke="#222" stroke-width="1.5" fill="none"/></svg>
      Send
    </button>
  </div>

  <!-- Filter chips (icons + text) -->
  <div class="row" id="filters1">
    <span id="chipOpenNow" class="pill" title="Open now">
      <!-- clock -->
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="#222" stroke-width="1.5"/><path d="M12 7v5l3 2" stroke="#222" stroke-width="1.5"/></svg>
      Open Now
    </span>
    <span id="chipAffordable" class="pill active" title="Max price">
      <!-- dollar -->
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 3v18M16 7.5c0-1.93-1.79-3.5-4-3.5S8 5.57 8 7.5 9.79 11 12 11s4 1.57 4 3.5S14.21 18 12 18s-4-1.57-4-3.5" stroke="#222" stroke-width="1.5" fill="none"/></svg>
      ≤ $$
    </span>
    <span id="chipRadius" class="pill" title="Search radius">
      <!-- pin -->
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 22s7-6.5 7-12a7 7 0 1 0-14 0c0 5.5 7 12 7 12Z" stroke="#222" stroke-width="1.5" fill="none"/><circle cx="12" cy="10" r="2.5" stroke="#222" stroke-width="1.5"/></svg>
      ≤ 5 mi
    </span>
  </div>

  <div class="row" id="filters2">
    <span class="pill">
      <!-- tag -->
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M10 4h7l3 3v7l-8 8-9-9 7-7Z" stroke="#222" stroke-width="1.5" fill="none"/></svg>
      Deals
    </span>
    <span class="pill">
      <!-- sliders -->
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M4 7h8M4 17h16M12 7v6M18 17v-6" stroke="#222" stroke-width="1.5"/></svg>
      More Filters
    </span>
  </div>

  <div class="row">
    <span class="pill">Restaurants</span>
  </div>

  <div id="status"></div>
  <div id="results"></div>
  <div id="detail" class="detail"></div>

  <script>
    const FN_PLACES  = '/.netlify/functions/places';
    const FN_DETAILS = '/.netlify/functions/placeDetails';
    const FN_PHOTO   = '/.netlify/functions/photo';

    // STATE
    let CURRENT_COORDS = { lat: 41.7508, lng: -88.1535 }; // fallback until RN sends real coords
    let filters = { openNow: false, maxPrice: 2, radiusMi: 5 };
    let saved = new Set(JSON.parse(localStorage.getItem('fw_saved') || '[]'));

    // ELs
    const q = document.getElementById('q');
    const go = document.getElementById('go');
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const detailEl  = document.getElementById('detail');
    const chipOpenNow    = document.getElementById('chipOpenNow');
    const chipAffordable = document.getElementById('chipAffordable');
    const chipRadius     = document.getElementById('chipRadius');
    const savedBtn       = document.getElementById('savedBtn');
    const savedCount     = document.getElementById('savedCount');

    function updateSavedCount(){ savedCount.textContent = String(saved.size); }
    updateSavedCount();

    // RN → Web: coords
    function setCoords(lat, lng){ CURRENT_COORDS = { lat, lng }; }
    function handleFWMessage(raw){
      try {
        const msg = JSON.parse(raw || '{}');
        if (msg.type === 'FW_COORDS' && msg.payload?.lat && msg.payload?.lng) {
          setCoords(msg.payload.lat, msg.payload.lng);
          if (!q.value) q.value = 'sushi';
          onSearch();
        }
      } catch {}
    }
    window.addEventListener('message', e => handleFWMessage(e.data), false);
    document.addEventListener('message', e => handleFWMessage(e.data), false);
    try { window.ReactNativeWebView?.postMessage(JSON.stringify({ type:'FW_READY' })); } catch {}

    // Filter chip behaviors
    chipOpenNow.addEventListener('click', () => {
      filters.openNow = !filters.openNow;
      chipOpenNow.classList.toggle('active', filters.openNow);
      onSearch();
    });
    chipAffordable.addEventListener('click', () => {
      filters.maxPrice = filters.maxPrice === 2 ? 3 : 2;
      chipAffordable.classList.toggle('active', filters.maxPrice <= 2);
      chipAffordable.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 3v18M16 7.5c0-1.93-1.79-3.5-4-3.5S8 5.57 8 7.5 9.79 11 12 11s4 1.57 4 3.5S14.21 18 12 18s-4-1.57-4-3.5" stroke="#222" stroke-width="1.5" fill="none"/></svg>
        ${filters.maxPrice <= 2 ? '≤ $$' : 'Up to $$$'}
      `;
      onSearch();
    });
    chipRadius.textContent = `≤ ${filters.radiusMi} mi`;
    chipRadius.addEventListener('click', () => {
      const order = [3,5,8];
      const idx = order.indexOf(filters.radiusMi);
      filters.radiusMi = order[(idx+1)%order.length];
      chipRadius.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 22s7-6.5 7-12a7 7 0 1 0-14 0c0 5.5 7 12 7 12Z" stroke="#222" stroke-width="1.5" fill="none"/><circle cx="12" cy="10" r="2.5" stroke="#222" stroke-width="1.5"/></svg>
        ≤ ${filters.radiusMi} mi
      `;
      onSearch();
    });

    // Saved list view (very simple)
    savedBtn.addEventListener('click', () => {
      if (!saved.size) { statusEl.textContent = 'No saved places yet.'; return; }
      statusEl.textContent = 'Saved places';
      detailEl.innerHTML = '';
      resultsEl.innerHTML = '';
      // We'll show basic IDs; real app would store names too.
      const ul = document.createElement('ul');
      saved.forEach(id => {
        const li = document.createElement('li');
        li.textContent = id;
        ul.appendChild(li);
      });
      resultsEl.appendChild(ul);
    });

    go.addEventListener('click', onSearch);
    q.addEventListener('keydown', e => { if (e.key === 'Enter') onSearch(); });

    async function onSearch(){
      resultsEl.innerHTML = '';
      detailEl.innerHTML  = '';
      statusEl.textContent = 'Searching…';

      const meters = Math.round(filters.radiusMi * 1609.34); // miles → meters
      // Bias to restaurants only by appending "restaurant" keyword
      const term = (q.value || 'sushi').trim();
      const query = term.toLowerCase().includes('restaurant') ? term : `${term} restaurant`;

      const body = {
        query,
        lat: CURRENT_COORDS.lat,
        lng: CURRENT_COORDS.lng,
        radius: meters,
        openNow: filters.openNow ? 1 : 0,
        maxprice: filters.maxPrice
      };

      try {
        const res = await fetch(FN_PLACES, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (data.error) {
          statusEl.textContent = `Places error: ${data.error}${data.error_message ? ' – ' + data.error_message : ''}`;
          return;
        }
        render(data.places || []);
      } catch (e) {
        statusEl.textContent = 'Error: ' + e.message;
      }
    }

    // helpers
    function dollars(n){ return n ? '$'.repeat(n) : ''; }
    function miles(from, to){
      if (!from || !to) return '';
      const Rmi=3958.7613, dLat=(to.lat-from.lat)*Math.PI/180, dLng=(to.lng-from.lng)*Math.PI/180;
      const a=Math.sin(dLat/2)**2 + Math.cos(from.lat*Math.PI/180)*Math.cos(to.lat*Math.PI/180)*Math.sin(dLng/2)**2;
      return (Rmi*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))).toFixed(1)+' mi';
    }
    function tagLink(t){ return `<a href="#" data-term="${t}">#${t.replace(/_/g,'')}</a>`; }

    function render(places){
      statusEl.textContent = places.length ? `Found ${places.length} places` : 'No results';

      resultsEl.innerHTML = places.map(p => {
        const distance = miles(CURRENT_COORDS, p.location);
        const img = p.photo_ref ? `${FN_PHOTO}?ref=${encodeURIComponent(p.photo_ref)}&maxwidth=900` : '';
        const tags = (p.types||[]).slice(0,4).map(tagLink).join(' ');
        const isSaved = saved.has(p.place_id);
        return `
          <div class="card" data-id="${p.place_id}">
            ${img ? `<img class="img" src="${img}" alt="" />` : `<div class="img"></div>`}
            <div class="pad">
              <div class="title">
                <div class="name">${p.name ?? 'Unknown'}</div>
                <div class="price">${dollars(p.price_level)}</div>
              </div>
              <div class="meta">★ ${p.rating ?? '—'} · ${p.user_ratings_total ?? 0} · ${distance}</div>
              <div class="rowBetween" style="margin-top:6px">
                <div class="meta tags">${tags}</div>
                <button class="heart ${isSaved ? 'saved':''}" type="button" aria-label="Save">
                  <!-- heart outline -->
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="${isSaved ? '#ff7f31' : 'none'}">
                    <path d="M12 21s-7-4.5-9-8.5C1 8.5 3.5 6 6.5 6c2 0 3.5 1 5.5 3 2-2 3.5-3 5.5-3C20.5 6 23 8.5 21 12.5 19 16.5 12 21 12 21Z" stroke="#ff7f31" stroke-width="1.5"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // Card click = open details (except when clicking a hashtag or heart)
      [...resultsEl.querySelectorAll('.card')].forEach(el => {
        el.addEventListener('click', (e) => {
          if (e.target.closest('.tags') || e.target.closest('.heart')) return;
          showDetails(el.dataset.id);
        });
      });

      // Heart toggle save
      [...resultsEl.querySelectorAll('.heart')].forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = btn.closest('.card')?.dataset.id;
          if (!id) return;
          if (saved.has(id)) { saved.delete(id); btn.classList.remove('saved'); }
          else { saved.add(id); btn.classList.add('saved'); }
          localStorage.setItem('fw_saved', JSON.stringify([...saved]));
          updateSavedCount();
        });
      });

      // Hashtags: click → fill search → run search
      [...resultsEl.querySelectorAll('.tags a')].forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const term = a.getAttribute('data-term');
          if (term) {
            q.value = term;
            onSearch();
          }
        });
      });
    }

    async function showDetails(place_id){
      detailEl.innerHTML = 'Loading details…';
      try {
        const res = await fetch(FN_DETAILS, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ place_id })
        });
        const d = await res.json();
        if (d.error) { detailEl.textContent = `Details error: ${d.error} ${d.error_message || ''}`; return; }
        const img = d.photo_ref ? `${FN_PHOTO}?ref=${encodeURIComponent(d.photo_ref)}&maxwidth=1200` : '';
        const hours = d.opening_hours?.weekday_text ? d.opening_hours.weekday_text.join('<br/>') : '';
        detailEl.innerHTML = `
          <div class="card" style="border-color:#ccc">
            ${img ? `<img class="img" src="${img}" alt="" style="height:220px" />` : ''}
            <div class="pad">
              <div class="title">
                <div class="name" style="font-size:18px">${d.name}</div>
                <div class="price">${dollars(d.price_level)}</div>
              </div>
              <div class="meta">★ ${d.rating ?? '—'} · ${d.user_ratings_total ?? 0}</div>
              <div class="meta">${d.address ?? ''}</div>
              <div class="meta">${d.phone ? '☎︎ ' + d.phone : ''} ${d.website ? ` • <a href="${d.website}" target="_blank" rel="noopener">Website</a>` : ''}</div>
              ${hours ? `<div class="meta" style="margin-top:6px">${hours}</div>` : ''}
            </div>
          </div>
        `;
      } catch (e) {
        detailEl.textContent = 'Failed to load details: ' + e.message;
      }
    }

    // Initial search
    q.value = 'sushi';
    onSearch();
  </script>
</body>
</html>
